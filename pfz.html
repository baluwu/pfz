<!DOCTYPE>
<html>

<body>
</body>
<script type="text/javascript" src="./js/phaser.min.js"></script>

<script type="text/javascript">
var game;
var cursors;
var cards;
var activeCard = null;
var dx =0, dy = 0;

window.onload = function() {
    game = new Phaser.Game(1024, 600);
    game.state.add("PlayGame", playGame)
    game.state.start("PlayGame");
}

var playGame = function(game) {}
playGame.prototype = {
  preload: function() {
    for (var i = 1; i <= 10; i++) {
      for (var j = 1; j <= 2; j++) {
        var img = (j % 2 ? 'x_' : 'd_') + i;
        game.load.image(img, 'assets/cards/' + img + '.jpg');
      }
    }
  },

  _makeCards: function() {
    var _cards = [];
    for (var i = 1; i <= 10; i++) {
      for (var j = 1; j <= 8; j++) {
        _cards.push({
          id: (i - 1) * 8 + j - 1,
          img: (j % 2 ? 'x_' : 'd_') + i
        });
      }
    }

    return _cards;
  },

  _createCards: function() {
    /*加载字牌*/
    cards = game.add.group();
    cards.enableBody = true;
    
    var my_cards = this._makeCards();
    Phaser.ArrayUtils.shuffle(my_cards);
    Phaser.ArrayUtils.shuffle(my_cards);

    var scale = 0.08;
    var x = 10;
    var y = (game.height) - 80;

    /*给自己发20张牌*/
    for (var i = 0; i < 2; i++) {
      var a_card = my_cards[i];
      var card = cards.create(x, y, a_card.img);
      card.scale.setTo(scale, scale); 

      card.body.gravity.y = 1000;  
      game.physics.arcade.enable(card);
      card.body.collideWorldBounds = true;
      card.inputEnabled = true;
      card.input.enableDrag();

      card.events.onInputDown.add(onDragStart);
      //card.events.onInputUp.add(onDragEnd);
      x += 35;
    }
  },

  create: function() {
    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.stage.backgroundColor = "#f1f1f1";

    this._createCards();
    
    //game.input.addMoveCallback(onMove, this);
    cursors = game.input.keyboard.createCursorKeys();
  },

  update: function () {
    game.physics.arcade.collide(cards, cards, function() {
      console.log(arguments);    
    });
  }
};

function onMove(e) {
  if (activeCard) {
    var x = game.input.activePointer.worldX;
    var y = game.input.activePointer.worldY;

    /*
    game.add.tween(activeCard).to(
      {
        x: x - dx,
        y: y - dy
      }, 
      1, 
      //Phaser.Easing.Cubic.Out, 
      Phaser.Easing.Linear.None, 
      true
    );
    */
    activeCard.x = x - dx;
    activeCard.y = y - dy;
  }
}

function onDragStart(e) {
  activeCard = e;

  var x = game.input.activePointer.worldX;
  var y = game.input.activePointer.worldY;

  dx = x - e.x;
  dy = y - e.y;

  cards.bringToTop(e);
}

function onDragEnd(e) {
  activeCard = null;
}

</script>
</html>
